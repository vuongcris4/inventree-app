name: iOS IPA (unsigned)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    name: build
    runs-on: macos-14

    env:
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      # 2) Xcode 15.4 (khớp với runner)
      - name: Select Xcode 15.4
        run: sudo xcode-select -s "/Applications/Xcode_15.4.app/Contents/Developer" || sudo xcode-select -p

      # 3) Đọc .fvmrc để lấy version/channel Flutter
      - name: Read FVM config (.fvmrc)
        uses: kuhnroyal/flutter-fvm-config-action@v2
        with:
          setup: false
          cache: true

      # 4) Cài Flutter đúng version từ .fvmrc
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          architecture: arm64
          cache: true

      # 5) (Tùy dự án) Thu gom bản dịch nếu bạn có script này
      - name: Collect translations (optional)
        if: ${{ hashFiles('lib/l10n/collect_translations.py') != '' }}
        run: |
          cd lib/l10n
          python3 collect_translations.py

      # 6) Cache pub
      - name: Cache Pub
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: flutter-pub-${{ runner.os }}-${{ env.FLUTTER_CHANNEL }}-${{ env.FLUTTER_VERSION }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            flutter-pub-${{ runner.os }}-${{ env.FLUTTER_CHANNEL }}-${{ env.FLUTTER_VERSION }}-

      # 7) Flutter doctor (tham khảo)
      - name: Flutter doctor
        run: |
          flutter --version
          dart --version
          flutter doctor -v

      # 8) Precache iOS và pub get
      - name: Precache iOS & Pub get
        run: |
          flutter precache --ios
          flutter pub get

      # 9) Cache CocoaPods
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: macOS-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            macOS-pods-

      # 10) Pod install
      - name: Install Pods
        working-directory: ios
        run: |
          pod repo update
          pod install

      # 11) Build unsigned IPA
      - name: Build iOS IPA (unsigned)
        run: |
          # Làm sạch nhẹ nhàng (tùy chọn)
          flutter clean
          # Build phát hành không ký
          flutter build ipa --release --no-codesign
        # Nếu có biến môi trường / cấu hình riêng, thêm vào env: ở đây

      # 12) Thu thập dSYM (nếu cần)
      - name: Zip dSYMs (optional)
        run: |
          mkdir -p build/ios/ipa
          if compgen -G "build/ios/archive/*.xcarchive/dSYMs/*.dSYM" > /dev/null; then
            pushd build/ios/archive
            zip -r ../ipa/dSYMs.zip ./*.xcarchive/dSYMs/*.dSYM
            popd
          fi

      # 13) Upload artifact (.ipa + dSYMs nếu có)
      - name: Upload unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-unsigned
          path: |
            build/ios/ipa/*.ipa
            build/ios/ipa/dSYMs.zip
          if-no-files-found: error
          retention-days: 7
